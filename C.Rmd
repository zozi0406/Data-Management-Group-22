---
title: "C"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(xml2)
library(tidyverse)
library(rvest)
```

```{r}
link<-"https://data.food.gov.uk/catalog/datasets/38dd8d6a-5ab1-4f50-b753-ab33288e3200"

xmllinks<-read_html(link) %>% html_nodes(".o-dataset-distribution--link") %>% html_attr("href")
xmllinks<-xmllinks[xmllinks %>% str_detect(".xml$")]
xmllinks<-xmllinks[xmllinks %>% str_detect("en-GB")]

dir.create("xmldata",showWarnings = F)

xmldatalist=list()
for (i in 1:length(xmllinks)) {

  link <- xmllinks[i]
  filename <- paste0("xmldata/",link %>% str_extract("(?<=/)[^/]+$"))
  
  if (!file.exists(filename)){
    download.file(link,filename)
  }
  
  nodes <- read_xml(filename) %>% xml_find_all("//EstablishmentDetail")
  ids<-xml_child(nodes,"FHRSID") %>% xml_text %>% trimws
  
  nodeslength<-xml_length(nodes)
  
  nodenames<-xml_children(nodes) %>% xml_name
  nodevalues<-xml_children(nodes) %>% xml_text %>% trimws
  
  df<-tibble(ID=rep(ids,nodeslength),
                 variable=nodenames,
                 values=nodevalues) %>%
    pivot_wider(names_from="variable",values_from="values") %>%
    add_column(Longitude=xml_child(nodes,search="Geocode") %>% xml_child("Longitude") %>% xml_text,
               Latitude=xml_child(nodes,search="Geocode") %>% xml_child("Latitude") %>% xml_text,
               Hygiene=xml_child(nodes,search="Scores") %>% xml_child("Hygiene") %>% xml_text,
               Structural=xml_child(nodes,search="Scores") %>% xml_child("Structural") %>% xml_text,
               ConfidenceInManagement=xml_child(nodes,search="Scores") %>% xml_child("ConfidenceInManagement") %>% xml_text)
  
  df$Scores<-NULL
  df$Geocode<-NULL
  df$ID<-NULL
  
  xmldatalist[[filename]]<-df
  if (i %% 10 == 0){
    paste0(i, " files processed from a total of ", length(xmllinks),".") %>% print()
  }

}
print("XML parsing finished.")
ratingsdata<-do.call(bind_rows,xmldatalist) %>% type_convert()
write_csv(ratingsdata,"C_output.csv")




```


